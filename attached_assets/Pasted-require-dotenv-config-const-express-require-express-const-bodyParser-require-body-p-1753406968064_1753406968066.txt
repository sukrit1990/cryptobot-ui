require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

const app = express();
app.use(bodyParser.json());

// ✅ 1. Create Customer
app.post('/create-customer', async (req, res) => {
  const { email, payment_method_id } = req.body;

  try {
    const customer = await stripe.customers.create({
      email,
      payment_method: payment_method_id,
      invoice_settings: {
        default_payment_method: payment_method_id
      }
    });

    res.json({ customer_id: customer.id });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});

// ✅ 2. Create Metered Subscription
app.post('/create-subscription', async (req, res) => {
  const { customer_id } = req.body;

  try {
    const subscription = await stripe.subscriptions.create({
      customer: customer_id,
      items: [
        {
          price: 'price_metered_12345', // Replace with your actual metered price ID
        },
      ],
      expand: ['latest_invoice.payment_intent'],
    });

    const subscriptionItemId = subscription.items.data[0].id;
    res.json({
      subscription_id: subscription.id,
      subscription_item_id: subscriptionItemId,
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});

// ✅ 3. Report Usage
app.post('/report-usage', async (req, res) => {
  const { subscription_item_id, usage_quantity } = req.body;

  try {
    const usageRecord = await stripe.usageRecords.create(subscription_item_id, {
      quantity: usage_quantity,
      timestamp: Math.floor(Date.now() / 1000),
      action: 'set', // or 'increment'
    });

    res.json({ usage_record_id: usageRecord.id });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  }
});

const PORT = process.env.PORT || 4242;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
